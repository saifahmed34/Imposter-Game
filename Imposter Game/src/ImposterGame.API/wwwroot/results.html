<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results - Imposter Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>ðŸŽ­ Game Results</h1>
        <p class="subtitle">Who was the imposter?</p>

        <div class="card">
            <div class="results-info" id="resultsInfo">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading results...</p>
                </div>
            </div>

            <div class="players-list" id="playersList">
                <h4>Final Votes:</h4>
                <div id="playersContainer"></div>
            </div>

            <button class="btn btn-primary" onclick="playAgain()">Play Again</button>
            <button class="btn btn-secondary" onclick="goHome()">Back to Home</button>
        </div>

        <div id="messageArea"></div>
    </div>

    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script>
        let roomId = null;
        let playerId = null;

        window.addEventListener('DOMContentLoaded', async () => {
            // Check if user is logged in
            roomId = sessionStorage.getItem('roomId');
            playerId = sessionStorage.getItem('playerId');
            
            if (!roomId || !playerId) {
                showMessage('No room found. Redirecting...', 'error');
                setTimeout(() => window.location.href = 'index.html', 1000);
                return;
            }
            
            await loadResults();
        });

        async function loadResults() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/Room/${roomId}`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await parseResponse(response);
                const room = data.room || data;
                
                displayResults(room);
                
            } catch (error) {
                console.error('Error loading results:', error);
                showMessage(`Failed to load results: ${error.message}`, 'error');
            }
        }

        function displayResults(room) {
            const resultsInfo = document.getElementById('resultsInfo');
            const playersContainer = document.getElementById('playersContainer');
            const players = room.players || [];
            
            // Find the imposter (C# uses PascalCase)
            const imposter = players.find(p => p.isImposter === true);
            const winner = room.winner || 'Unknown';
            const votedPlayer = room.votedOutPlayer || null;
            
            // Display results
            if (imposter) {
                const wasFound = votedPlayer && votedPlayer.id === imposter.id;
                
                resultsInfo.innerHTML = `
                    <div class="result-display ${wasFound ? 'result-civilians' : 'result-imposter'}">
                        <h2>${wasFound ? 'ðŸŽ‰ Civilians Win!' : 'ðŸ˜ˆ Imposter Wins!'}</h2>
                        <p class="result-text">
                            The imposter was <strong>${imposter.name}</strong>!
                            ${wasFound ? 'They were successfully voted out!' : 'They got away with it!'}
                        </p>
                    </div>
                `;
            } else {
                resultsInfo.innerHTML = `
                    <div class="result-display">
                        <h2>Game Ended</h2>
                        <p class="result-text">Game results are being calculated...</p>
                    </div>
                `;
            }
            
            // Display voting results
            if (players.length > 0) {
                const votes = room.votes || [];
                const voteCount = {};
                votes.forEach(v => {
                    if (v.targetId) {
                        voteCount[v.targetId] = (voteCount[v.targetId] || 0) + 1;
                    }
                });
                
                playersContainer.innerHTML = players.map(p => {
                    const votes = voteCount[p.id] || 0;
                    const isImposterPlayer = p.isImposter === true;
                    return `
                        <div class="player-item ${isImposterPlayer ? 'player-imposter' : ''}">
                            <span>
                                ${p.name || 'Unknown'}
                                ${isImposterPlayer ? ' <span class="badge badge-imposter">IMPOSTER</span>' : ''}
                            </span>
                            <span class="vote-count">${votes} ${votes === 1 ? 'vote' : 'votes'}</span>
                        </div>
                    `;
                }).join('');
            }
        }

        function playAgain() {
            sessionStorage.removeItem('roomId');
            sessionStorage.removeItem('playerId');
            window.location.href = 'index.html';
        }

        function goHome() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
